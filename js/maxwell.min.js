/* 
    https://github.com/RRozza/RRozza.github.io/license
    @author Renzo Rozza / https://github.com/RRozza
*/
var mx_cmds=(function(){var commands={'stop':{'render.stop':1},'start':{'render.start':1},'requestall':{'ws.requestall':1},'requestCamera':{'sm.request.camera':1},'requestObjects':{'ws.objects':1},'requestTextures':{'ws.textures':1},'subscribe':{'render.subscribe':1},'quality':{'viewport.changequality':9},'resolution':{'viewport.resolution':1,'viewport.width':window.innerWidth,'viewport.height':window.innerHeight},'action':{'sm.action':{'type':'action','id':'mxsfragment','newData':'','oldData':'','senderId':'proxy'}},};return{json:function(key){return commands[key]},flag:function(data,id){data['flag.id']=id;return data},action:function(id,fragments){var action=commands.action;action['sm.action'].senderId=id;action['sm.action'].newData=fragments;return action},id:function(data){return data['subscriber.setid']},camera:function(data){return[data['sm.camera'],data['sm.camera.transform']]},scene:function(id,autostart){if(autostart)
return{'ws.loadscene':id,'ws.autostart':1};else return{'ws.loadscene':id}},assets:function(data){return data['asset.infos']},download:function(id){return{'asset.download':id}},iso:function(data){return data.sensor.iso},shutter:function(data){return data.optics.shutterSpeed},fstop:function(data){return data.optics.fStop},focalLength:function(data){return data.coordinates.focusDistance},fragmentParameter:function(id,value){return 'set float "renderCamera" '+id+' '+value+';'},fragmentPosition:function(p){return 'set position "renderCameraTransform" motionSteps[0].local.position '+p.x+' '+p.y+' '+p.z+';'},fragmentPosAndRot:function(p,r){var fragment1='set position "renderCameraTransform" motionSteps[0].local.position '+p.x+' '+p.y+' '+p.z+';';var fragment2='set quaternion "renderCameraTransform" motionSteps[0].local.rotation '+r.x+' '+r.y+' '+r.z+' '+r.w+';';return fragment1+'\n'+fragment2},fragmentPosAndFocus:function(p,f){var fragment1='set position "renderCameraTransform" motionSteps[0].local.position '+p.x+' '+p.y+' '+p.z+';';var fragment2='set float "renderCamera" focusDistance '+f+';';return fragment1+'\n'+fragment2},fragmentAll:function(p,r,f){var fragment1='set position "renderCameraTransform" motionSteps[0].local.position '+p.x+' '+p.y+' '+p.z+';';var fragment2='set quaternion "renderCameraTransform" motionSteps[0].local.rotation '+r.x+' '+r.y+' '+r.z+' '+r.w+';';var fragment3='set float "renderCamera" focusDistance '+f+';';return fragment1+'\n'+fragment2+'\n'+fragment3},fragmentBaking:function(data){var steps=[];for(var i=0,len=data.length;i<len;++i)
steps.push({'id':i,'baked':data[i].baked,'transform':data[i].transform});return{'sm.bake':Â steps}}}})();var mx_vector=function(){var _x=0.0;var _y=0.0;var _z=0.0;this.x=function(){return _x};this.y=function(){return _y};this.z=function(){return _z};this.assign=function(x,y,z){_x=x;_y=y;_z=z}};mx_vector.prototype={copy:function(v){var x=v.x();var y=v.y();var z=v.z();this.assign(x,y,z)},add:function(v){var x=this.x()+v.x();var y=this.y()+v.y();var z=this.z()+v.z();this.assign(x,y,z)},scale:function(s){var x=this.x()*s;var y=this.y()*s;var z=this.z()*s;this.assign(x,y,z)},cross:function(v){var x=this.y()*v.z()-this.z()*v.y();var y=this.z()*v.x()-this.x()*v.z();var z=this.x()*v.y()-this.y()*v.x();var result=new mx_vector();result.assign(x,y,z);return result},normalize:function(){var x=this.x();var y=this.y();var z=this.z();var sum=x*x+y*y+z*z;if(sum===0.0)
this.assign(0.0,0.0,0.0);else if(sum!=1.0)
this.scale(1.0/Math.sqrt(sum))},negate:function(){var x=-1*this.x();var y=-1*this.y();var z=-1*this.z();var result=new mx_vector();result.assign(x,y,z);return result},debug:function(){console.log('x = '+this.x());console.log('y = '+this.y());console.log('z = '+this.z())}};mx_vector.add=function(v1,v2){var x=v1.x()+v2.x();var y=v1.y()+v2.y();var z=v1.z()+v2.z();var result=new mx_vector();result.assign(x,y,z);return result};mx_vector.subtract=function(v1,v2){var x=v1.x()-v2.x();var y=v1.y()-v2.y();var z=v1.z()-v2.z();var result=new mx_vector();result.assign(x,y,z);return result};mx_vector.scale=function(v,s){var x=v.x()*s;var y=v.y()*s;var z=v.z()*s;var result=new mx_vector();result.assign(x,y,z);return result};mx_vector.axisX=function(){var result=new mx_vector();result.assign(1.0,0.0,0.0);return result};mx_vector.axisY=function(){var result=new mx_vector();result.assign(0.0,1.0,0.0);return result};mx_vector.axisZ=function(){var result=new mx_vector();result.assign(0.0,0.0,-1.0);return result};mx_vector.distance=function(v1,v2){var x1=v1.x();var y1=v1.y();var z1=v1.z();var x2=v2.x();var y2=v2.y();var z2=v2.z();var x3=x2-x1;var y3=y2-y1;var z3=z2-z1;return Math.sqrt(x3*x3+y3*y3+z3*z3)};var mx_quaternion=function(){var _s=1.0;var _x=0.0;var _y=0.0;var _z=0.0;this.s=function(){return _s};this.x=function(){return _x};this.y=function(){return _y};this.z=function(){return _z};this.assign=function(s,x,y,z){_s=s;_x=x;_y=y;_z=z}};mx_quaternion.prototype={copy:function(q){var s=q.s();var x=q.x();var y=q.y();var z=q.z();this.assign(s,x,y,z)},add:function(q){var s=this.s()+q.s();var x=this.x()+q.x();var y=this.y()+q.y();var z=this.z()+q.z();this.assign(s,x,y,z)},multiply:function(q){var s1=this.s();var x1=this.x();var y1=this.y();var z1=this.z();var s2=q.s();var x2=q.x();var y2=q.y();var z2=q.z();this.assign(s1*s2-x1*x2-y1*y2-z1*z2,s1*x2+x1*s2+y1*z2-z1*y2,s1*y2+y1*s2+z1*x2-x1*z2,s1*z2+z1*s2+x1*y2-y1*x2)},norm:function(){var s=this.s();var x=this.x();var y=this.y();var z=this.z();return Math.sqrt(s*s+x*x+y*y+z*z)},normalize:function(){var s=this.s();var x=this.x();var y=this.y();var z=this.z();var invMod=1.0/this.norm();s*=invMod;x*=invMod;y*=invMod;z*=invMod;this.assign(s,x,y,z)},inverse:function(){var s=this.s();var x=this.x();var y=this.y();var z=this.z();var normSq=s*s+x*x+y*y+z*z;if(normSq===0.0){return mx_quaternion()}
normSq=1/normSq;var result=new mx_quaternion();result.assign(s*normSq,-x*normSq,-y*normSq,-z*normSq);return result},rotateVector:function(v){var s1=this.s();var x1=this.x();var y1=this.y();var z1=this.z();var p=new mx_quaternion();p.assign(0.0,v.x(),v.y(),v.z());p.normalize();var x2=p.x();var y2=p.y();var z2=p.z();var s3=-x1*x2-y1*y2-z1*z2;var x3=s1*x2+y1*z2-z1*y2;var y3=s1*y2+z1*x2-x1*z2;var z3=s1*z2+x1*y2-y1*x2;var x4=x3*s1-s3*x1-y3*z1+z3*y1;var y4=y3*s1-s3*y1-z3*x1+x3*z1;var z4=z3*s1-s3*z1-x3*y1+y3*x1;var result=new mx_vector();result.assign(x4,y4,z4);return result},fromAxisAngle:function(axis,angle){var halfAngle=angle*0.5;var x=axis.x();var y=axis.y();var z=axis.z();var sin=Math.sin(halfAngle);var cos=Math.cos(halfAngle);var sin_norm=sin/Math.hypot(x,y,z);this.assign(cos,x*sin_norm,y*sin_norm,z*sin_norm)},debug:function(){console.log('s = '+this.s());console.log('x = '+this.x());console.log('y = '+this.y());console.log('z = '+this.z())}};mx_quaternion.multiply=function(q1,q2){var s1=q1.s();var x1=q1.x();var y1=q1.y();var z1=q1.z();var s2=q2.s();var x2=q2.x();var y2=q2.y();var z2=q2.z();var result=new mx_quaternion();result.assign(s1*s2-x1*x2-y1*y2-z1*z2,s1*x2+x1*s2+y1*z2-z1*y2,s1*y2+y1*s2+z1*x2-x1*z2,s1*z2+z1*s2+x1*y2-y1*x2);return result};var mx_camera=function(){var _iso=null;var _fstop=null;var _shutter=null;this.iso=function(){return _iso};this.fstop=function(){return _fstop};this.shutter=function(){return _shutter};this.setIso=function(iso){_iso=iso};this.setFStop=function(fstop){_fstop=fstop};this.setShutter=function(shutter){_shutter=shutter}};mx_camera.prototype={setup:function(params){var iso=mx_cmds.iso(params);this.setIso(iso);var shutter=mx_cmds.shutter(params);this.setShutter(shutter);var fstop=mx_cmds.fstop(params);this.setFStop(fstop)},changeParameter:function(id,value){if(!this.enabled())return null;if(id==='iso')
this.setIso(value);if(id==='shutter')
this.setShutter(value);if(id==='fstop')
this.setFStop(value);if(this.multirender())
return 'params '+id+' '+value;else return mx_cmds.fragmentParameter(id,value)},};var mx_canvas=function(){var _active=0;var _hidden=!1;this.active=function(){return _active};this.hidden=function(){return _hidden};this.setActive=function(active){_active=active};this.setHidden=function(hidden){_hidden=hidden}};mx_canvas.prototype={getFrontBuffer:function(){var id=this.active();return document.getElementById('fire'+id)},getBackBuffer:function(){var id=1-this.active();return document.getElementById('fire'+id)},flipBuffers:function(){var hidden=this.hidden();if(!hidden){this.getBackBuffer().style.visibility='visible';this.getFrontBuffer().style.visibility='hidden'}
this.setActive(1-this.active())},draw:function(data){var that=this;var image=new Image();image.onload=function(){var canvas=that.getBackBuffer();canvas.width=window.innerWidth;canvas.height=window.innerHeight;var context=canvas.getContext('2d');context.drawImage(this,0,0);that.flipBuffers()};image.src='data:image/png;base64,'+data},show:function(){this.setHidden(!1)},hide:function(){this.getBackBuffer().style.visibility='hidden';this.getFrontBuffer().style.visibility='hidden';this.setHidden(!0)}};var mx_fire=function(){var _camera=new mx_camera();var _canvas=new mx_canvas();this.canvas=function(){return _canvas};this.camera=function(){return _camera}};mx_fire.prototype={draw:function(data){var canvas=this.canvas();canvas.draw(data)},show:function(){var canvas=this.canvas();canvas.show()},hide:function(){var canvas=this.canvas();canvas.hide()},setCamera:function(data){var camera=this.camera();camera.setup(data)}};var mx_webgl=function(){var _camera=null;var _scene=null;var _renderer=null;var _controls=null;var _running=!1;var _meshes={};var _focal=1;var _baking=[];var render=function(){if(!_running)return;_renderer.render(_scene,_camera)};var animate=function(){if(!_running)return;requestAnimationFrame(animate);_controls.update();render()};this.camera=function(){return _camera};this.scene=function(){return _scene};this.renderer=function(){return _renderer};this.controls=function(){return _controls}
this.hide=function(){if(_renderer===null)return;_renderer.domElement.style.visibility='hidden'};this.show=function(){if(_renderer===null)return;_renderer.domElement.style.visibility='visible'};this.setCamera=function(data){if(_camera!==null)
return;var filmSize=27;var focalLength=35;var fov=2.0*180.0/Math.PI*Math.atan(0.5*filmSize/focalLength);_camera=new THREE.PerspectiveCamera(fov,window.innerWidth/window.innerHeight,0.02,1000);_camera.position.set(data.origin[0],data.origin[1],data.origin[2]);var target=new THREE.Vector3(data.target[0],data.target[1],data.target[2]);_camera.lookAt(target);_focal=_camera.position.distanceTo(target);_controls=new THREE.OrbitControls(_camera);_controls.addEventListener('change',render);animate()};this.buildCamera=function(mode){switch(mode){case 0:return mx_cmds.fragmentPosAndRot(_camera.position,_camera.quaternion);case 1:_focal=_focal*_camera.zoom;return mx_cmds.fragmentPosAndFocus(_camera.position,_focal);case 2:return mx_cmds.fragmentPosition(_camera.position)}};this.loadObject=function(data){var loader=new THREE.OBJLoader();var obj=loader.parse(data.obj);var mesh=obj.children[0];if(mesh===undefined)
return;mesh.material=new THREE.MeshBasicMaterial({color:Math.random()*0xFFFFFF,wireframe:!0,wireframeLinewidth:2});_scene.add(mesh);_meshes[data.id]=mesh};this.loadTexture=function(data){if(_meshes[data.id]===undefined)
return;var image=new Image();image.src='data:image/png;base64,'+data.tex;var texture=new THREE.Texture();texture.image=image;texture.needsUpdate=!0;_meshes[data.id].material=new THREE.MeshBasicMaterial({map:texture});_meshes[data.id].material.needsUpdate=!0};this.setBakingStep=function(){var step=mx_cmds.fragmentAll(_camera.position,_camera.quaternion,_focal);_baking.push({baked:!1,transform:step})};this.getBakingSteps=function(){var fragments=mx_cmds.fragmentBaking(_baking);return fragments};this.bakingDone=function(){for(var i=0,len=_baking.length;i<len;++i)
_baking[i].baked=!0};this.init=function(){if(_running)
return;_running=!0;_scene=new THREE.Scene();var ambientLight=new THREE.AmbientLight(0xFFFFFF,1);_scene.add(ambientLight);var canvas=document.getElementById('webgl');_renderer=new THREE.WebGLRenderer({canvas:canvas,alpha:!0});_renderer.setPixelRatio(1);_renderer.setSize(window.innerWidth,window.innerHeight,!0);_renderer.setViewport(0,0,window.innerWidth,window.innerHeight);_renderer.setClearColor(0xFFFFFF,0)};this.deinit=function(){_camera=null;_scene=null;_renderer=null;_controls=null;_running=!1;_meshes={};_focal=1;_baking=[]};this.start=function(){if(_running)
this.deinit();this.init()}};var mx_ws=function(url,methods){var _ws=new WebSocket(url);var _methods=methods;_ws.onopen=function(event){};_ws.onerror=function(event){};_ws.onmessage=function(event){var data=JSON.parse(event.data);for(var method in _methods){if(data[method]!==undefined||data.id===method){_methods[method](data);break}}};this.send=function(data){_ws.send(JSON.stringify(data))}};var mx_render=function(){var _fire=new mx_fire();var _webgl=new mx_webgl();this.states={IDLE:0,FIRE:1,WEBGL:2};var _state=this.states.IDLE;this.fire=function(){return _fire};this.webgl=function(){return _webgl};this.state=function(){return _state};this.setState=function(state){_state=state}};mx_render.prototype={start:function(){this.setState(this.states.FIRE);var webgl=this.webgl();webgl.start()},setCamera:function(data){var fire=this.fire();fire.setCamera(data[0]);var webgl=this.webgl();webgl.setCamera(data[1])},setCameraParameter:function(key,value){var fire=this.fire();var camera=fire.camera();return camera.changeParameter(key,value)},setObjectWebGL:function(data){var webgl=this.webgl();webgl.loadObject(data)},setTextureWebGL:function(data){var webgl=this.webgl();webgl.loadTexture(data);webgl.bakingDone()},setBakingStep:function(){var webgl=this.webgl();webgl.setBakingStep()},getBakingSteps:function(){var webgl=this.webgl();return webgl.getBakingSteps()},drawFIRE:function(data){var fire=this.fire();var webgl=this.webgl();var state=this.state();if(state===this.states.FIRE){webgl.hide();fire.show();fire.draw(data)}},enableFIRE:function(mode){var state=this.state();if(state!==this.states.FIRE){this.setState(this.states.FIRE);var webgl=this.webgl();return webgl.buildCamera(mode)}
return null},enableWebGL:function(){var state=this.state();if(state!==this.states.WEBGL){this.setState(this.states.WEBGL);var fire=this.fire();var webgl=this.webgl();fire.hide();webgl.show()}},enable:function(){var webgl=this.webgl();var controls=webgl.controls();controls.enabled=!0;mx_input.enable()},disable:function(){var webgl=this.webgl();var controls=webgl.controls();controls.enabled=!1;mx_input.disable()}};var mx_input=(function(){_mode=null;_enabled=!1;var mouseUp=function(event){if(_enabled)
mx_client.onRenderMode('fire',_mode)};var mouseDown=function(event){_mode=event.button;if(_enabled)
mx_client.onRenderMode('webgl')};document.getElementById('viewport').addEventListener('mousedown',mouseDown,!1);document.getElementById('viewport').addEventListener('mouseup',mouseUp,!1);return{enable:function(){_enabled=!0},disable:function(){_enabled=!1}}})();var mx_gui=function(){var _modes={media:null,motion:null};var _scene=null;var _spinner=new Spinner();this.spinner=function(){return _spinner};this.getMode=function(id){return _modes[id]};this.setMode=function(id,value){_modes[id]=value;var icon=document.getElementById(id).firstChild;icon.src='thirdparty/svg/'+id+value+'.svg'};this.invertMode=function(id){if(_modes[id]===null)
_modes[id]=1;_modes[id]=1-_modes[id]};this.getScene=function(){return _scene};this.setScene=function(scene){_scene=scene}};mx_gui.prototype={hideElement:function(key){document.getElementById(key).style.display='none'},showElement:function(key){document.getElementById(key).style.display='inline-block'},toggleElement:function(key){var elemStyle=document.getElementById(key).style;if(elemStyle.display===undefined||elemStyle.display===''){elemStyle.display='inline-block';return}
if(elemStyle.display!=='none')
elemStyle.display='none';else elemStyle.display='inline-block'},hideSpinner:function(){this.spinner().stop()},showSpinner:function(){var body=document.getElementsByTagName('BODY')[0];this.spinner().spin(body)},getChecked:function(key){return document.getElementById(key).checked},getValue:function(key){return document.getElementById(key).value},setValues:function(params){document.getElementById('iso').value=mx_cmds.iso(params);document.getElementById('shutter').value=mx_cmds.shutter(params);document.getElementById('fstop').value=mx_cmds.fstop(params)},switchMode:function(key){var element=document.getElementById(key);if(element===null||element===undefined)
return;if(this.getMode(key)!==undefined){this.invertMode(key);var icon=element.firstChild;var mode=this.getMode(key);icon.src='thirdparty/svg/'+key+mode+'.svg'}},buildTable:function(key,data){var content='';var assets=mx_cmds.assets(data);for(var i=0,len=assets.length;i<len;++i){var asset=assets[i];if(asset.type==='scene'&&asset.sync==='sync'){content+='<tr>';content+='<td>'+asset.name+'</td>';content+='<td><button class="button-primary" onclick="mx_client.onRun(\''+asset._id+'\')">Play</button></td>';content+='</tr>'}}
var tbody=document.getElementById(key);tbody.innerHTML=content},cameraFlash:function(){document.body.style.backgroundColor='rgba(255,255,255,1)';document.getElementById('viewport').style.opacity=0;setTimeout(function(){document.getElementById('viewport').style.opacity=1;document.body.style.backgroundColor='rgba(200,200,200,0.8)'},200)}};var mx_client=(function(){var _id=null;var _ws=null;var _gui=new mx_gui();var _render=new mx_render();var _testing=!1;var send=function(data){if(typeof(data)!=='object')return;if(_ws===null)return;data=mx_cmds.flag(data,_id);_ws.send(data)};var action=function(fragments){if(fragments===null)
return;var data=mx_cmds.action(_id,fragments);send(data)};var connection=function(data){if(_id!==null)return;_id=mx_cmds.id(data);var cmd=mx_cmds.json('requestall');send(cmd)};var assets=function(data){if(typeof(data)!=='object')return;_gui.buildTable('assets_tbody',data);_gui.hideSpinner();_gui.showElement('assets')};var render=function(data){if(_testing)mx_timer.run();_gui.showElement('menu');_render.start();var cmd1=mx_cmds.json('requestCamera');send(cmd1);var cmd2=mx_cmds.json('requestObjects');send(cmd2);var cmd3=mx_cmds.json('requestTextures');send(cmd3);var cmd4=mx_cmds.json('subscribe');send(cmd4)};var frames=function(data){_gui.hideSpinner();if(typeof(data)!=='object')return;if(_testing)mx_timer.markFrame();_render.drawFIRE(data['render.imagedata'])};var camera=function(data){if(typeof(data)!=='object')return;var camera=mx_cmds.camera(data);_gui.setValues(camera[0]);_render.setCamera(camera)};var started=function(){_gui.setMode('media',1);if(_testing){mx_timer.markRender();if(!mx_test.running())setTimeout(mx_test.execute,2000)}};var _restart=null;var done=function(){_gui.setMode('media',0);if(_restart!==null){_restart();_restart=null}};var texture=function(data){_render.enable();_gui.hideSpinner();_render.setTextureWebGL(data['bake.texture'])};var object=function(data){_render.enable();_gui.hideSpinner();_render.setObjectWebGL(data['asset.object'])};return{onConnect:function(){var domain=_gui.getValue('domain');domain=(domain==='')?'localhost':domain;var port=_gui.getValue('port');port=(port==='')?'10010':port;url='ws://'+domain+':'+port;_ws=new mx_ws(url,{'subscriber.setid':connection,'asset.infos':assets,'sceneLoaded':render,'render.imagedata':frames,'sm.camera':camera,'render.started':started,'render.done':done,'bake.texture':texture,'asset.object':object});_gui.hideElement('connection');_gui.showSpinner();var multirender=_gui.getChecked('multirender');return!1},onRun:function(id){if(id===undefined)return;var cmd=null;var restart=function(){cmd=mx_cmds.json('quality');send(cmd);cmd=mx_cmds.json('resolution');send(cmd);cmd=mx_cmds.scene(id,!0);send(cmd);if(_testing)mx_timer.markAction();_gui.hideElement('assets');_gui.showSpinner()};var mode=_gui.getMode('media');if(mode===null||mode===0){restart()}else{cmd=mx_cmds.json('stop');send(cmd);_restart=restart}},onAssets:function(){_gui.toggleElement('assets')},onMediaMode:function(key){var cmd=null;var mode=_gui.getMode(key);if(mode===1){cmd=mx_cmds.json('stop');send(cmd)}else{cmd=mx_cmds.json('start');send(cmd)}
_gui.switchMode(key)},onCameraParameters:function(){_gui.toggleElement('optics')},onChangeParameter:function(key,value){if(_testing)mx_timer.markAction();var fragments=_render.setCameraParameter(key,value);action(fragments)},onRenderMode:function(key,value){if(key==='fire'){var fragments=_render.enableFIRE(value);action(fragments)}else if(key==='webgl'){var mode=_gui.getMode('media');if(mode===1){cmd=mx_cmds.json('stop');send(cmd);_gui.switchMode(key)}
_render.enableWebGL()}},onMoveCamera:function(deltaX,deltaY,scale,angle){if(_testing)mx_timer.markAction();moveCamera(deltaX,deltaY,scale,angle)},onBakingStep:function(){var ok=confirm("Do you want to store baking step? If so this location will be used for baking.");if(ok){_gui.cameraFlash();_render.setBakingStep()}},onBake:function(){var ok=confirm("Do you want to start baking process? This may take awhile...");if(ok){_render.disable();var fragments=_render.getBakingSteps();send(fragments);setTimeout(function(){_gui.showSpinner()},500)}},onPower:function(){location.reload()},onTimer:function(){if(_testing===!1){_testing=!0;mx_timer.run();mx_timer.markRender();if(!mx_test.running())setTimeout(mx_test.execute,100)}}}})();mx_client.onConnect();