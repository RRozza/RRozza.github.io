<!DOCTYPE html>
<html>
    <head>
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <style>
            body { background: #000000; overflow: hidden; }
            canvas { display: block; }
        </style>

        <title>Baking</title>
    </head>
    <body>
        <canvas id="webgl" class="buffer"></canvas>

        <script type="text/javascript" src="thirdparty/three.min.js"></script>
        <script type="text/javascript" src="thirdparty/OrbitControls.js"></script>
        <script type="text/javascript" src="thirdparty/VRControls.js"></script>
        <script type="text/javascript" src="thirdparty/Detector.js"></script>
        <script type="text/javascript" src="thirdparty/DDSLoader.js"></script>
        <script type="text/javascript" src="thirdparty/OBJLoader.js"></script>
        <script type="text/javascript" src="thirdparty/MTLLoader.js"></script>

        <script>
            var _name = null;
            var _camera = null;
            var _scene = null;
            var _renderer = null;
            var _controls = null;

            function init () {
                _scene = new THREE.Scene();

                var ambientLight = new THREE.AmbientLight(0xFFFFFF, 1);
                _scene.add(ambientLight);

                var canvas = document.getElementById('webgl');
                _renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                _renderer.setPixelRatio(1);
                _renderer.setSize(window.innerWidth, window.innerHeight, true);
                _renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
                _renderer.setClearColor(0x000000, 0);
            };

            var render = function () {
                _renderer.render(_scene, _camera);
            };

            var animate = function () {
                requestAnimationFrame(animate);
                _controls.update();
                render();
            };

            var mipmap = function (size) {
                var imageCanvas = document.createElement('canvas');
                var context = imageCanvas.getContext('2d');
                imageCanvas.width = size;
                imageCanvas.height = size;
                return imageCanvas;
            };

            function setCamera (data) {
                var filmSize = 27;
                var focalLength = 35;
                var fov = 2.0*180.0/Math.PI*Math.atan(0.5*filmSize/focalLength);

                _camera = new THREE.PerspectiveCamera(fov,  window.innerWidth/window.innerHeight, 0.02, 1000);
                _camera.position.set(data.origin[0], data.origin[1], data.origin[2]);

                var target = new THREE.Vector3(data.target[0], data.target[1], data.target[2]);
                _camera.lookAt(target);

                _controls = new THREE.OrbitControls(_camera);
                _controls.addEventListener('change', render);

                animate();
            };

            function load (entity) {
				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
						console.log( Math.round(percentComplete, 2) + '% downloaded' );
					}
				};

				var onError = function ( xhr ) {
                    console.log( xhr.error );
                 };

                THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );

				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.setPath( 'images/' + _name + '/objects/' );
				mtlLoader.load( entity + '.mtl', function( materials ) {
					
                    materials.preload();

					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( './images/' + _name + '/objects/' );
					objLoader.load( entity + '.obj', function ( object ) {
						_scene.add( object );
					}, onProgress, onError );

				});
                /*
                var callback = function (image) {
                    var material = new THREE.MeshBasicMaterial({ map: image });
                    var objLoader = new THREE.OBJLoader();
                    objLoader.load('./images/' + _name + '/objects/' + entity + '.obj', function(obj) {
                        var mesh = obj.children[0];
                        mesh.material = material;
                        _scene.add(mesh);
                    });
                };

                var texture = new THREE.TextureLoader().load('./images/' + _name + '/textures/256/' + entity + '.png', callback);
                */
            };

            function getParameterByName(name, url) {
                if (!url)
                    url = window.location.href;

                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
                var results = regex.exec(url);

                if (!results)
                    return null;

                if (!results[2])
                    return '';

                return decodeURIComponent(results[2].replace(/\+/g, " "));
            };

            init();
            
            
            _name = getParameterByName("scene");
            if (_name === "Puma") {
                setCamera({ origin: [0.4, 0.4, 0.4], target: [0.0, 0.0, 0.0] });

                [
                    /*'Puma025550', 'Puma050255', 'Puma0125125',
                    'Puma0125255', 'Puma255050', 'Puma255500',
                    'Puma500255', 'Puma502550', 'Puma1010255',
                    'Puma1025510', 'Puma1250255', 'Puma1252550',
                    'Puma2551010', 'Puma10255255', 'Puma25510125',
                    'Puma25510255', 'Puma25512510', 'Puma50100200',
                    'Puma250250250', 'Puma125125255', 'Puma125255125',*/
                    'Puma125125125'
                ].forEach(function (e) {
                    load(e);
                });
            }

            if (_name === "Room") {
                setCamera({ origin: [-20.0, 15.0, -20.0], target: [0.0, 0.0, 0.0] });

                [
                    'Room00125', 'Room00255', 'Room01250',
                    'Room02550', 'Room12500', 'Room014050',
                    'Room017050', 'Room25500', 'Room120500',
                    'Room0125125', 'Room0125255', 'Room125500',
                    'Room140050', 'Room170500', 'Room0255125',
                    'Room500125', 'Room500140', 'Room500170',
                    'Room500255', 'Room501200', 'Room501250',
                    'Room1250125', 'Room1251250', 'Room1252550',
                    'Room1700170', 'Room1701700', 'Room1702550',
                    'Room2550120', 'Room2550125', 'Room2551250',
                    'Room2551800', 'Room2552550', 'Room5017050',
                    'Room5025550', 'Room5050170', 'Room5050255',
                    'Room25550170', 'Room50170170', 'Room130255190'
                ].forEach(function (e) {
                    load(e);
                });
            }

        </script>
</html>
